# تحسينات طي الكروت بعد النشر

## المشكلة الأصلية
كانت الكروت (الأزرار) تبقى نشطة بعد نشر الإعلانات، مما يسمح للمستخدمين بالتفاعل معها حتى بعد انتهاء النشر.

## الحل المطبق

### 1. إضافة نظام تخزين الرسائل المرسلة
- تم إضافة دالة `storeSentMessage()` لحفظ معرفات الرسائل مع معرفات القنوات
- يتم حفظ كل رسالة مرسلة مع:
  - معرف الرسالة
  - معرف القناة
  - الطابع الزمني

### 2. تحسين دالة طي الكروت
- تم تطوير دالة `collapseAdButtons()` لتعمل مع الرسائل المحفوظة
- تقوم بجلب جميع الرسائل المرسلة للإعلان
- تعديل كل رسالة لإزالة الأزرار (طي الكروت)
- تسجيل النتائج والأخطاء

### 3. التكامل مع عملية النشر
- يتم استدعاء `storeSentMessage()` عند إرسال كل رسالة إعلان
- يتم استدعاء `collapseAdButtons()` بعد انتهاء النشر
- التكامل الكامل مع دالة `disableAdAfterPublish()`

## الملفات المحدثة

### `ads.js`
- إضافة دالة `storeSentMessage()`
- تحسين دالة `collapseAdButtons()`
- تحديث دالة `sendAdToChannels()` لحفظ الرسائل
- تحديث دالة `disableAdAfterPublish()` لطي الكروت

## سير العمل الجديد

1. **عند النشر:**
   - إرسال الإعلان إلى القنوات المحددة
   - حفظ معرف كل رسالة مع معرف القناة
   - تطبيق نظام حذف المكررات حسب القناة

2. **بعد انتهاء النشر:**
   - تعطيل الإعلان في قاعدة البيانات
   - جلب جميع الرسائل المرسلة للإعلان
   - طي الكروت (إزالة الأزرار) من جميع الرسائل
   - تسجيل النتائج

## النتائج المتوقعة

✅ **طي الكروت التلقائي:** جميع أزرار الإعلانات تصبح غير نشطة بعد انتهاء النشر

✅ **تتبع دقيق:** حفظ وتتبع جميع الرسائل المرسلة لكل إعلان

✅ **أداء محسن:** عدم ترك أزرار نشطة غير مرغوب فيها

✅ **تجربة مستخدم أفضل:** وضوح حالة الإعلان (منتهي/نشط)

## ملاحظات مهمة

- يتم حفظ الرسائل مؤقتاً في الذاكرة أثناء تشغيل البوت
- يتم تنظيف البيانات القديمة تلقائياً
- النظام يعمل مع جميع أنواع الإعلانات (فورية ومجدولة)
- متوافق مع نظام حذف المكررات الجديد

---

**تاريخ التحديث:** 19 سبتمبر 2025  
**الحالة:** مطبق ويعمل بنجاح ✅