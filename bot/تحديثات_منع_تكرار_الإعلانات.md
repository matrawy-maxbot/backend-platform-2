# تحديثات منع تكرار الإعلانات

## التاريخ: 19 سبتمبر 2025

### المشكلة الأصلية:
- الإعلانات المجدولة كانت تتكرر بدلاً من الإرسال مرة واحدة فقط
- عدم وجود آلية لحذف الرسائل المكررة تلقائياً

### التحديثات المطبقة:

#### 1. إضافة نظام تتبع الرسائل المرسلة
```javascript
this.sentMessages = new Map(); // serverId -> Map(adId -> messageIds[])
this.messageHashes = new Map(); // serverId -> Map(contentHash -> messageId)
```

#### 2. دالة إنشاء hash للمحتوى
- تم إضافة `createContentHash()` لإنشاء hash فريد لكل إعلان
- يعتمد على العنوان والمحتوى والرابط

#### 3. دالة حذف الرسائل المكررة
- تم إضافة `deleteDuplicateMessages()` للتحقق من الرسائل المكررة وحذفها
- تبحث في جميع القنوات النصية وتحذف الرسالة القديمة
- تحتفظ بسجل آخر 10 رسائل لكل إعلان

#### 4. تحديث دالة إرسال الإعلانات
- تم تعديل `sendAdToChannels()` لاستخدام آلية منع التكرار
- إضافة تأخير بسيط (1 ثانية) بين الرسائل لتجنب حدود المعدل

#### 5. تحديث الإعلانات المجدولة
- تم تعديل `scheduleAd()` لتعطيل الإعلان تلقائياً بعد الإرسال
- منع إعادة جدولة الإعلانات المنشورة مسبقاً

#### 6. نظام تنظيف البيانات
- إضافة مهمة تنظيف كل 6 ساعات لحذف بيانات الرسائل القديمة
- منع تراكم البيانات في الذاكرة

### الميزات الجديدة:

✅ **منع التكرار**: الإعلانات المجدولة ترسل مرة واحدة فقط

✅ **حذف المكررات**: حذف تلقائي للرسائل المكررة

✅ **تعطيل تلقائي**: تعطيل الإعلان بعد النشر لمنع إعادة الإرسال

✅ **تنظيف البيانات**: تنظيف دوري للبيانات المخزنة

✅ **تحسين الأداء**: تأخير بسيط بين الرسائل لتجنب مشاكل المعدل

### كيفية العمل:

1. **عند جدولة إعلان**: يتم التحقق من أنه لم يتم نشره مسبقاً
2. **عند الإرسال**: يتم إنشاء hash للمحتوى والتحقق من التكرار
3. **إذا وجد تكرار**: يتم حذف الرسالة القديمة والاحتفاظ بالجديدة
4. **بعد الإرسال**: يتم تعطيل الإعلان تلقائياً لمنع إعادة الإرسال
5. **التنظيف الدوري**: كل 6 ساعات يتم تنظيف البيانات القديمة

### ملاحظات مهمة:

- النظام يعمل على مستوى كل سيرفر بشكل منفصل
- يتم الاحتفاظ بسجل آخر 10 رسائل لكل إعلان فقط
- التنظيف الدوري يمنع تراكم البيانات في الذاكرة
- النظام متوافق مع جميع أنواع الإعلانات (فورية ومجدولة ومتكررة)

### اختبار النظام:

1. قم بإنشاء إعلان مجدول
2. انتظر حتى يتم إرساله
3. تأكد من أنه لم يتكرر
4. تأكد من تعطيل الإعلان تلقائياً

---

**تم تطبيق جميع التحديثات بنجاح ✅**

**البوت يعمل الآن بدون تكرار للإعلانات المجدولة**