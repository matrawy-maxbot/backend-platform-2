# إصلاح مشكلة الإعلانات المنتهية الصلاحية

## المشكلة
كان البوت يرسل إعلانات منتهية الصلاحية دون فحص تاريخ انتهاء الصلاحية، مما يؤدي إلى إرسال إعلانات غير صالحة للمستخدمين.

## الحل المطبق

### 1. فحص تاريخ انتهاء الصلاحية
تم إضافة فحص شامل لتاريخ انتهاء الصلاحية (`expiryDate`) في جميع نقاط إرسال الإعلانات:

- **الإعلانات الفورية**: فحص في `sendImmediateAd()` و `sendImmediateAdDirect()`
- **الإعلانات المجدولة**: فحص في `scheduleAd()`
- **الإعلانات المتكررة**: فحص في `scheduleRecurringAd()`
- **معالجة تحديث الإعلانات**: فحص في `processAdsUpdate()`
- **إعادة الجدولة**: فحص في `rescheduleAds()`

### 2. إيقاف المهام المتكررة المنتهية الصلاحية
عند اكتشاف إعلان متكرر منتهي الصلاحية، يتم:
- إيقاف المهمة المجدولة (`job.destroy()`)
- إزالة المهمة من قائمة المهام المجدولة
- تسجيل رسالة توضيحية في السجل

### 3. تنظيف تلقائي للإعلانات المنتهية الصلاحية
تم إضافة مهمة تنظيف تلقائية تعمل كل ساعة (`cleanupExpiredAds()`) لـ:
- فحص جميع المهام المجدولة
- إيقاف المهام المرتبطة بإعلانات منتهية الصلاحية
- تنظيف الذاكرة من المهام غير المستخدمة

### 4. رسائل السجل التوضيحية
تم إضافة رسائل سجل واضحة باللغة العربية لتتبع:
- الإعلانات المنتهية الصلاحية التي تم تجاهلها
- المهام المجدولة التي تم إيقافها
- عمليات التنظيف التلقائي

## الميزات الجديدة

### فحص متعدد المستويات
- فحص في مرحلة الجدولة
- فحص في مرحلة التنفيذ
- فحص في مرحلة المعالجة

### حماية من الأخطاء
- منع إرسال إعلانات منتهية الصلاحية
- إيقاف المهام المتكررة المنتهية الصلاحية تلقائياً
- تنظيف الذاكرة من المهام غير المستخدمة

### تسجيل مفصل
- رسائل واضحة عند اكتشاف إعلانات منتهية الصلاحية
- تتبع عمليات التنظيف والإيقاف
- معلومات مفيدة للمطورين والمديرين

## كيفية عمل النظام الجديد

1. **عند إنشاء إعلان جديد**: يتم فحص تاريخ انتهاء الصلاحية قبل الجدولة
2. **عند تنفيذ إعلان مجدول**: يتم فحص الصلاحية قبل الإرسال
3. **للإعلانات المتكررة**: يتم فحص الصلاحية في كل تكرار وإيقاف المهمة عند انتهاء الصلاحية
4. **التنظيف التلقائي**: كل ساعة يتم فحص وتنظيف المهام المنتهية الصلاحية

## النتيجة
✅ لن يتم إرسال أي إعلانات منتهية الصلاحية
✅ توفير موارد النظام بإيقاف المهام غير المستخدمة
✅ رسائل سجل واضحة لتتبع العمليات
✅ حماية شاملة في جميع مراحل معالجة الإعلانات

---

**تاريخ الإصلاح**: 19 سبتمبر 2025
**الملفات المعدلة**: `bot/ads.js`
**نوع الإصلاح**: إصلاح أمان وتحسين أداء